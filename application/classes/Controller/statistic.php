<?php defined('SYSPATH') or die('No direct script access.');class Controller_Statistic extends Mytemplate {    public function action_index()    {        if(isset($_POST['prof']))        {            $prof = +$_POST['prof'];            $view = View::factory('statistic');            $view->professors = $this->get_prof();            if($this->first($prof))            {                list ($view->fio,$view->data) = $this->first($prof);                list ($view->vop,$view->variants,$view->quest,$view->data1) = $this->other_q($prof);            }            else                $view->fio=0;            $view->comments = $this->get_comments($prof);        }        else        {            $view = View::factory('statistic_login');            $view->professors = $this->get_prof();        }        $this->template->content = $view;    }    function get_prof()    {        $professors = DB::select()->from('professors')->execute()->as_array();        foreach($professors as $row)        {            if($row['type']==1)            {                $array['lec'][] = $row;            }            elseif($row['type']==2)            {                $array['pr'][] = $row;            }        }        return $array;    }    function first($prepod,$vopros_id=0)    {        $table = DB::select('fio','number','text','questions.id','ans_text','price','mark')            ->from('statistics')            ->join('professors','CROSS')            ->on('statistics.st_prof','=','professors.id')            ->join('questions','CROSS')            ->on('st_num_quest','=','questions.id')            ->join('answers','CROSS')            ->on('answers.id','=','st_ans')            ->order_by('number','asc')            ->order_by('questions.id')            ->where('professors.id','=',$prepod)            ->where('number','=','1')            ->execute()            ->as_array();        if($table)        {            $all = 0;            $neo = 0;            $i=1;$j=1; //счётчики            foreach($table as $row)            {                $array[$row['id']]['text']=$row['text'];                $fio = $row['fio'];                if(isset($array[$row['id']]['all']))                    $array[$row['id']]['all'] += $row['price'];                else                    $array[$row['id']]['all'] = $row['price'];                if($row['mark']==1)                {                    if(isset($array[$row['id']]['neo']))                        $array[$row['id']]['neo'] += $row['price'];                    else                        $array[$row['id']]['neo'] = $row['price'];                }                $i++;                $j++;                $array[$row['id']]['all'] /=$i;                if(isset($array[$row['id']]['neo']))                    $array[$row['id']]['neo'] /=$j;            }            return array($fio, $array);        }        return array();    }    function get_all_ans($num)    {        $answers = DB::select()->from('answers')->where('num_ques','=',$num)->execute()->as_array();        foreach($answers as $row)        {            $array[] = $row['ans_text'];        }        return $array;    }    function other_q($prepod)    {        $table1 = DB::select('fio','number','text','answers.id','ans_text','price','mark')            ->from('statistics')            ->join('professors','CROSS')            ->on('statistics.st_prof','=','professors.id')            ->join('questions','CROSS')            ->on('st_num_quest','=','questions.id')            ->join('answers','CROSS')            ->on('answers.id','=','st_ans')            ->order_by('number','asc')            ->where('professors.id','=',$prepod)            ->execute()            ->as_array();        $num=0;        $vop = array();        foreach($table1 as $row)        {            if($num != $row['number'])            {                $num = $row['number'];                $vop[] = $num; // номера вопросов                $variants[$num] = $this->get_all_ans($num);                $quest[$num] = $row['text'];                foreach($variants[$num] as $v)                {                    $array[$num][$v]['stat'] = 0;                    $array[$num][$v]['mark'] = 0;                }            }            $array[$num][$row['ans_text']]['stat']++;            if($row['mark']==1)            {                $array[$num][$row['ans_text']]['mark']++;            }        }        if($vop && $variants && $quest && $array)            return array($vop,$variants,$quest,$array);        else            return array();    }    function get_comments($prepod)    {        $comments = DB::select()->from('comments')->where('id_pr','=',$prepod)->execute()->as_array();        if($comments)        {            foreach($comments as $row)            {                $array[]=$row['comm'];            }            return $array;        }        else        {            return 0;        }    }}